name: deploy_backend

on:
  push:
    tags:
      - "v*.*.*"

# Publish backend image to GHCR so releases share a single source of truth.
permissions:
  contents: read
  packages: write

jobs:
  docker:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.image_tag.outputs.value }}
    env:
      IMAGE_NAME: ghcr.io/oppulence-engineering/check-if-email-exists-backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Capture image tag
        id: image_tag
        run: echo "value=${{ steps.meta.outputs.version }}" >> "$GITHUB_OUTPUT"

  helm-deploy:
    runs-on: ubuntu-latest
    needs: docker
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG_B64 }}
        run: |
          mkdir -p "$HOME/.kube"
          echo "$KUBE_CONFIG_B64" | base64 -d > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"

      - name: Deploy Helm chart
        env:
          RELEASE_NAME: check-if-email-exists
          NAMESPACE: paperless
          IMAGE_TAG: ${{ needs.docker.outputs.image_tag }}
          HELM_POSTGRES_URL: ${{ secrets.HELM_POSTGRES_URL }}
          HELM_RABBIT_URL: ${{ secrets.HELM_RABBIT_URL }}
          HELM_PROXY_HOST: ${{ secrets.RCH__PROXY__HOST }}
          HELM_PROXY_PORT: ${{ secrets.RCH__PROXY__PORT }}
          HELM_PROXY_USERNAME: ${{ secrets.RCH__PROXY__USERNAME }}
          HELM_PROXY_PASSWORD: ${{ secrets.RCH__PROXY__PASSWORD }}
          HELM_HEADER_SECRET: ${{ secrets.HELM_HEADER_SECRET }}
          HELM_SENTRY_DSN: ${{ secrets.HELM_SENTRY_DSN }}
        run: |
          if [ -z "$RELEASE_NAME" ] || [ -z "$NAMESPACE" ]; then
            echo "HELM_RELEASE_NAME and HELM_NAMESPACE secrets must be set."
            exit 1
          fi
          set -euo pipefail
          args=(
            --namespace "$NAMESPACE"
            --create-namespace
            --set image.repository=ghcr.io/oppulence-engineering/check-if-email-exists-backend
            --set image.tag="$IMAGE_TAG"
          )
          add_arg() {
            local key="$1"
            local value="$2"
            if [ -n "$value" ]; then
              args+=(--set "$key=$value")
            fi
          }
          add_arg "config.secretEnv.RCH__STORAGE__POSTGRES__DB_URL" "$HELM_POSTGRES_URL"
          add_arg "config.secretEnv.RCH__WORKER__RABBITMQ__URL" "$HELM_RABBIT_URL"
          add_arg "config.secretEnv.RCH__PROXY__HOST" "$HELM_PROXY_HOST"
          add_arg "config.secretEnv.RCH__PROXY__PORT" "$HELM_PROXY_PORT"
          add_arg "config.secretEnv.RCH__PROXY__USERNAME" "$HELM_PROXY_USERNAME"
          add_arg "config.secretEnv.RCH__PROXY__PASSWORD" "$HELM_PROXY_PASSWORD"
          add_arg "config.secretEnv.RCH__HEADER_SECRET" "$HELM_HEADER_SECRET"
          add_arg "config.secretEnv.RCH__SENTRY_DSN" "$HELM_SENTRY_DSN"

          helm upgrade --install "$RELEASE_NAME" helm/check-if-email-exists "${args[@]}"
